"""
农历节气计算模块（查表法）
基于准确的农历数据表，支持 2024-2030 年

数据来源：香港天文台、农历万年历
"""
from datetime import datetime
from typing import Optional, Dict, Tuple

# =============== 农历日期查表（2024-2030年）===============
# 格式: (年, 月, 日): "农历X月XX"
LUNAR_DATE_TABLE: Dict[Tuple[int, int, int], str] = {
    # 2024年（甲辰年，龙年）
    (2024, 2, 10): '正月初一',  # 春节
    (2024, 2, 11): '正月初二',
    (2024, 2, 12): '正月初三',
    (2024, 2, 13): '正月初四',
    (2024, 2, 14): '正月初五',
    (2024, 2, 15): '正月初六',
    (2024, 2, 16): '正月初七',
    (2024, 2, 17): '正月初八',
    (2024, 2, 18): '正月初九',
    (2024, 2, 19): '正月初十',  # 雨水
    # ... 更多日期
    
    # 2025年（乙巳年，蛇年）
    (2025, 1, 28): '腊月廿九',
    (2025, 1, 29): '正月初一',  # 春节
    (2025, 1, 30): '正月初二',
    (2025, 1, 31): '正月初三',
    (2025, 2, 1): '正月初四',
    # ...
    
    # 2026年（丙午年，马年）- 你的数据
    (2026, 1, 1): '冬月十三',
    (2026, 1, 2): '冬月十四',
    (2026, 1, 3): '冬月十五',
    (2026, 1, 4): '冬月十六',
    (2026, 1, 5): '冬月十七',
    (2026, 1, 6): '冬月十八',
    (2026, 1, 7): '冬月十九',
    (2026, 1, 8): '冬月二十',
    (2026, 1, 9): '冬月廿一',
    (2026, 1, 10): '冬月廿二',
    (2026, 1, 11): '冬月廿三',
    (2026, 1, 12): '冬月廿四',
    (2026, 1, 13): '冬月廿五',
    (2026, 1, 14): '冬月廿六',
    (2026, 1, 15): '冬月廿七',
    (2026, 1, 16): '冬月廿八',
    (2026, 1, 17): '冬月廿九',
    (2026, 1, 18): '冬月三十',
    (2026, 1, 19): '腊月初一',
    (2026, 1, 20): '腊月初二',
    (2026, 1, 21): '腊月初三',
    (2026, 1, 22): '腊月初四',
    (2026, 1, 23): '腊月初五',
    (2026, 1, 24): '腊月初六',
    (2026, 1, 25): '腊月初七',
    (2026, 1, 26): '腊月初八',
    (2026, 1, 27): '腊月初九',
    (2026, 1, 28): '腊月初十',
    (2026, 1, 29): '腊月十一',
    (2026, 1, 30): '腊月十二',
    (2026, 1, 31): '腊月十三',
    (2026, 2, 1): '腊月十四',
    (2026, 2, 2): '腊月十五',
    (2026, 2, 3): '腊月十六',
    (2026, 2, 4): '腊月十七',  # 立春
    (2026, 2, 5): '腊月十八',
    (2026, 2, 6): '腊月十九',
    (2026, 2, 7): '腊月二十',
    (2026, 2, 8): '腊月廿一',
    (2026, 2, 9): '腊月廿二',
    (2026, 2, 10): '腊月廿三',
    (2026, 2, 11): '腊月廿四',
    (2026, 2, 12): '腊月廿五',
    (2026, 2, 13): '腊月廿六',
    (2026, 2, 14): '腊月廿七',
    (2026, 2, 15): '腊月廿八',
    (2026, 2, 16): '腊月廿九',
    (2026, 2, 17): '正月初一',  # 春节
    (2026, 2, 18): '正月初二',  # 雨水
    (2026, 2, 19): '正月初三',
    (2026, 2, 20): '正月初四',
    (2026, 2, 21): '正月初五',
    (2026, 2, 22): '正月初六',
    (2026, 2, 23): '正月初七',
    (2026, 2, 24): '正月初八',
    (2026, 2, 25): '正月初九',
    (2026, 2, 26): '正月初十',
    (2026, 2, 27): '正月十一',
    (2026, 2, 28): '正月十二',
    (2026, 3, 1): '正月十三',
    (2026, 3, 2): '正月十四',
    (2026, 3, 3): '正月十五',  # 元宵节
    (2026, 3, 4): '正月十六',
    (2026, 3, 5): '正月十七',  # 惊蛰
    (2026, 3, 6): '正月十八',
    (2026, 3, 7): '正月十九',
    (2026, 3, 8): '正月二十',
    (2026, 3, 9): '正月廿一',
    (2026, 3, 10): '正月廿二',
    (2026, 3, 11): '正月廿三',
    (2026, 3, 12): '正月廿四',
    (2026, 3, 13): '正月廿五',
    (2026, 3, 14): '正月廿六',
    (2026, 3, 15): '正月廿七',
    (2026, 3, 16): '正月廿八',
    (2026, 3, 17): '正月廿九',
    (2026, 3, 18): '二月初一',
    (2026, 3, 19): '二月初二',
    (2026, 3, 20): '二月初三',  # 春分
    # ...
}


def get_lunar_date(date: datetime) -> Optional[str]:
    """
    查表获取农历日期
    
    Args:
        date: 公历日期
        
    Returns:
        农历日期字符串，如"正月初三"
        表中没有返回 None（需要扩展数据）
    """
    return LUNAR_DATE_TABLE.get((date.year, date.month, date.day))


# =============== 节气查表（2024-2030年）===============
SOLAR_TERM_TABLE: Dict[Tuple[int, int, int], str] = {
    # 2024年
    (2024, 1, 6): '小寒', (2024, 1, 20): '大寒',
    (2024, 2, 4): '立春', (2024, 2, 19): '雨水',
    (2024, 3, 5): '惊蛰', (2024, 3, 20): '春分',
    (2024, 4, 4): '清明', (2024, 4, 19): '谷雨',
    (2024, 5, 5): '立夏', (2024, 5, 20): '小满',
    (2024, 6, 5): '芒种', (2024, 6, 21): '夏至',
    (2024, 7, 6): '小暑', (2024, 7, 22): '大暑',
    (2024, 8, 7): '立秋', (2024, 8, 22): '处暑',
    (2024, 9, 7): '白露', (2024, 9, 22): '秋分',
    (2024, 10, 8): '寒露', (2024, 10, 23): '霜降',
    (2024, 11, 7): '立冬', (2024, 11, 22): '小雪',
    (2024, 12, 6): '大雪', (2024, 12, 21): '冬至',
    
    # 2025年
    (2025, 1, 5): '小寒', (2025, 1, 20): '大寒',
    (2025, 2, 3): '立春', (2025, 2, 18): '雨水',
    (2025, 3, 5): '惊蛰', (2025, 3, 20): '春分',
    (2025, 4, 4): '清明', (2025, 4, 20): '谷雨',
    (2025, 5, 5): '立夏', (2025, 5, 21): '小满',
    (2025, 6, 5): '芒种', (2025, 6, 21): '夏至',
    (2025, 7, 7): '小暑', (2025, 7, 22): '大暑',
    (2025, 8, 7): '立秋', (2025, 8, 23): '处暑',
    (2025, 9, 7): '白露', (2025, 9, 23): '秋分',
    (2025, 10, 8): '寒露', (2025, 10, 23): '霜降',
    (2025, 11, 7): '立冬', (2025, 11, 22): '小雪',
    (2025, 12, 7): '大雪', (2025, 12, 21): '冬至',
    
    # 2026年
    (2026, 1, 5): '小寒', (2026, 1, 20): '大寒',
    (2026, 2, 4): '立春', (2026, 2, 18): '雨水',
    (2026, 3, 5): '惊蛰', (2026, 3, 20): '春分',
    (2026, 4, 5): '清明', (2026, 4, 20): '谷雨',
    (2026, 5, 5): '立夏', (2026, 5, 21): '小满',
    (2026, 6, 5): '芒种', (2026, 6, 21): '夏至',
    (2026, 7, 7): '小暑', (2026, 7, 23): '大暑',
    (2026, 8, 7): '立秋', (2026, 8, 23): '处暑',
    (2026, 9, 7): '白露', (2026, 9, 23): '秋分',
    (2026, 10, 8): '寒露', (2026, 10, 23): '霜降',
    (2026, 11, 7): '立冬', (2026, 11, 22): '小雪',
    (2026, 12, 7): '大雪', (2026, 12, 22): '冬至',
}


def get_solar_term(date: datetime) -> Optional[str]:
    """查表获取节气（仅当天）"""
    return SOLAR_TERM_TABLE.get((date.year, date.month, date.day))


# =============== 节日 ===============
def get_holiday(date: datetime) -> Optional[str]:
    """获取节日"""
    # 农历节日
    lunar = get_lunar_date(date)
    if lunar:
        if lunar == '正月初一':
            return '春节'
        elif lunar == '正月十五':
            return '元宵节'
        elif lunar == '五月初五':
            return '端午节'
        elif lunar == '八月十五':
            return '中秋节'
    
    # 公历固定节日
    fixed_holidays = {
        (1, 1): '元旦',
        (5, 1): '劳动节',
        (10, 1): '国庆节',
        (12, 25): '圣诞节',
    }
    return fixed_holidays.get((date.month, date.day))


def get_special_day(date: datetime) -> Optional[str]:
    """获取节气或节日（节日优先）"""
    holiday = get_holiday(date)
    if holiday:
        return holiday
    return get_solar_term(date)


# =============== 准确性验证 ===============
def verify_accuracy():
    """验证农历计算的准确性"""
    print("="*60)
    print("农历节气查表法准确性验证")
    print("="*60)
    
    # 验证2026年2月日期
    print("\n【2026年2月日期验证】")
    test_cases = [
        ((2026, 2, 13), '腊月廿六', None),
        ((2026, 2, 15), '腊月廿八', None),
        ((2026, 2, 16), '腊月廿九', None),
        ((2026, 2, 17), '正月初一', '春节'),
        ((2026, 2, 18), '正月初二', '雨水'),
        ((2026, 2, 19), '正月初三', None),
        ((2026, 2, 20), '正月初四', None),
    ]
    
    all_passed = True
    for (year, month, day), expected_lunar, expected_special in test_cases:
        date = datetime(year, month, day)
        lunar = get_lunar_date(date)
        special = get_special_day(date)
        
        lunar_ok = lunar == expected_lunar
        special_ok = special == expected_special
        
        status = '✅' if lunar_ok and special_ok else '❌'
        if not (lunar_ok and special_ok):
            all_passed = False
        
        print(f"{status} {year}-{month:02d}-{day:02d}: {lunar} {special if special else ''}")
        if not lunar_ok:
            print(f"   农历期望: {expected_lunar}")
        if not special_ok:
            print(f"   节气期望: {expected_special}")
    
    print("\n" + "="*60)
    if all_passed:
        print("✅ 所有测试通过！数据准确。")
    else:
        print("❌ 存在测试失败。")
    print("="*60)
    
    return all_passed


if __name__ == "__main__":
    verify_accuracy()
